#!/bin/bash
#
# Pre-commit hook to maintain warning-free status
#
# This hook checks core components for warnings before allowing commits
# to prevent regressions in warning-free status.

set -e

echo "üîç Pre-commit: Checking warning-free status..."

# Core components that must be warning-free
CORE_COMPONENTS=("common" "policy-service")
FAILED_COMPONENTS=()

# Check each core component for warnings
for component in "${CORE_COMPONENTS[@]}"; do
    echo "  Checking $component..."
    
    # Run cargo check and capture warnings
    if cargo check -p "$component" 2>&1 | grep -q "warning:"; then
        warning_count=$(cargo check -p "$component" 2>&1 | grep -c "warning:" || true)
        echo "    ‚ùå $component: $warning_count warnings found"
        FAILED_COMPONENTS+=("$component")
    else
        echo "    ‚úÖ $component: warning-free"
    fi
done

# Report results
if [ ${#FAILED_COMPONENTS[@]} -eq 0 ]; then
    echo "‚úÖ All core components are warning-free. Commit allowed."
    exit 0
else
    echo ""
    echo "‚ùå COMMIT BLOCKED: Core components have warnings:"
    for component in "${FAILED_COMPONENTS[@]}"; do
        echo "   - $component"
    done
    echo ""
    echo "Fix warnings with: cargo check -p <component>"
    echo "Or run: ./scripts/maintain-warning-free.sh"
    exit 1
fi