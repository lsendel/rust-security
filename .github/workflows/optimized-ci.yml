name: Optimized CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: stable
  RUSTFLAGS: -D warnings

jobs:
  # Detect changes to optimize builds
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.changes.outputs.rust }}
      workflows: ${{ steps.changes.outputs.workflows }}
      docs: ${{ steps.changes.outputs.docs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            rust:
              - '**/*.rs'
              - '**/Cargo.toml'
              - '**/Cargo.lock'
              - 'rust-toolchain.toml'
            workflows:
              - '.github/workflows/**'
            docs:
              - '**/*.md'
              - 'docs/**'

  # Core compilation check
  check:
    name: Compilation Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    strategy:
      fail-fast: false
      matrix:
        package: [auth-core, common, api-contracts, auth-service, policy-service, compliance-tools]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: check-${{ matrix.package }}-${{ hashFiles('**/Cargo.lock') }}
          cache-on-failure: true

      - name: Check ${{ matrix.package }}
        run: cargo check -p ${{ matrix.package }} --all-features

  # Workspace-level operations
  workspace:
    name: Workspace Operations
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: workspace-${{ hashFiles('**/Cargo.lock') }}
          cache-on-failure: true

      - name: Check workspace compilation
        run: cargo check --workspace --all-features

      - name: Format check
        run: cargo fmt --all -- --check

      - name: Clippy check
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  # Focused testing
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: [changes, check]
    if: needs.changes.outputs.rust == 'true'
    strategy:
      fail-fast: false
      matrix:
        package: [auth-core, common, api-contracts, auth-service, policy-service, compliance-tools]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: test-${{ matrix.package }}-${{ hashFiles('**/Cargo.lock') }}
          cache-on-failure: true

      - name: Test ${{ matrix.package }}
        run: |
          # Run tests with proper error handling
          if ! cargo test -p ${{ matrix.package }} --all-features; then
            echo "::error::Tests failed for ${{ matrix.package }}"
            exit 1
          fi

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: security-${{ hashFiles('**/Cargo.lock') }}
          cache-on-failure: true

      - name: Install cargo-audit
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Security audit
        run: cargo audit --deny warnings

      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny

      - name: Dependency check
        run: cargo deny check

  # Final status check
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [changes, check, workspace, test, security]
    if: always()
    
    steps:
      - name: Check all jobs
        run: |
          # Check if any required job failed
          if [[ "${{ needs.check.result }}" == "failure" || 
                "${{ needs.workspace.result }}" == "failure" || 
                "${{ needs.test.result }}" == "failure" || 
                "${{ needs.security.result }}" == "failure" ]]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi
          
          # Skip if no Rust changes
          if [[ "${{ needs.changes.outputs.rust }}" != "true" ]]; then
            echo "No Rust changes detected, skipping CI"
            exit 0
          fi
          
          echo "âœ… All CI checks passed successfully!"

      - name: Success summary
        if: needs.changes.outputs.rust == 'true'
        run: |
          echo "## ðŸŽ‰ CI Pipeline Success!" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… All checks passed:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Compilation** - All packages compile successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª **Tests** - All test suites pass" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ **Format** - Code formatting is correct" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Ž **Clippy** - No linting issues found" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ **Security** - No security vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Platform Status:" >> $GITHUB_STEP_SUMMARY
          echo "- **auth-core** âœ… Core authentication functionality" >> $GITHUB_STEP_SUMMARY
          echo "- **common** âœ… Shared utilities and types" >> $GITHUB_STEP_SUMMARY
          echo "- **api-contracts** âœ… API definitions and contracts" >> $GITHUB_STEP_SUMMARY
          echo "- **auth-service** âœ… Main authentication service" >> $GITHUB_STEP_SUMMARY
          echo "- **policy-service** âœ… Authorization and policy engine" >> $GITHUB_STEP_SUMMARY
          echo "- **compliance-tools** âœ… Compliance and audit utilities" >> $GITHUB_STEP_SUMMARY
