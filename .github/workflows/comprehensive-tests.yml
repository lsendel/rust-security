name: Comprehensive Test Suite

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'auth-service/**'
      - '.github/workflows/comprehensive-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'auth-service/**'
      - '.github/workflows/comprehensive-tests.yml'
  schedule:
    # Run comprehensive tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_performance_tests:
        description: 'Run performance tests'
        required: false
        default: 'true'
        type: boolean
      run_security_tests:
        description: 'Run security tests'
        required: false
        default: 'true'
        type: boolean
      run_benchmarks:
        description: 'Run benchmarks'
        required: false
        default: 'false'
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  TEST_MODE: 1
  REQUEST_SIGNING_SECRET: test_secret_for_ci
  DISABLE_RATE_LIMIT: 1

jobs:
  # Quick validation job for fast feedback
  quick-validation:
    name: Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
        
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          auth-service/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('auth-service/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Check formatting
      run: cargo fmt --all --check
      working-directory: auth-service
      
    - name: Run clippy
      run: cargo clippy --all-features --all-targets -- -D warnings
      working-directory: auth-service
      
    - name: Compile check
      run: cargo check --all-features
      working-directory: auth-service
      
    - name: Quick test validation
      run: ./scripts/quick_test_validation.sh
      working-directory: auth-service

  # Unit tests job
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quick-validation
    
    strategy:
      matrix:
        rust: [stable, beta, nightly]
        
    continue-on-error: ${{ matrix.rust != 'stable' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
        
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          auth-service/target
        key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('auth-service/Cargo.lock') }}
        
    - name: Run unit tests
      run: |
        cargo test --lib --bins \
          --all-features \
          --verbose \
          -- --test-threads=2 --nocapture
      working-directory: auth-service
      env:
        RUST_LOG: debug

  # Integration tests job
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: quick-validation
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          auth-service/target
        key: ${{ runner.os }}-integration-cargo-${{ hashFiles('auth-service/Cargo.lock') }}
        
    - name: Run integration tests
      run: |
        cargo test --test '*' integration \
          --all-features \
          --verbose \
          -- --test-threads=1 --nocapture
      working-directory: auth-service
      env:
        REDIS_URL: redis://localhost:6379
        RUST_LOG: debug

  # Security tests job
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: quick-validation
    if: github.event.inputs.run_security_tests != 'false'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          auth-service/target
        key: ${{ runner.os }}-security-cargo-${{ hashFiles('auth-service/Cargo.lock') }}
        
    - name: Run security tests
      run: |
        cargo test --test '*' security \
          --all-features \
          --verbose \
          -- --test-threads=1 --nocapture
      working-directory: auth-service
      env:
        RUST_LOG: debug
        
    - name: Run property-based tests
      run: |
        cargo test --test '*' property \
          --all-features \
          --verbose \
          -- --test-threads=2 --nocapture
      working-directory: auth-service
      env:
        PROPTEST_CASES: 500
        QUICKCHECK_TESTS: 500

  # Performance tests job
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [unit-tests, integration-tests]
    if: github.event.inputs.run_performance_tests != 'false'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          auth-service/target
        key: ${{ runner.os }}-performance-cargo-${{ hashFiles('auth-service/Cargo.lock') }}
        
    - name: Build release binary
      run: cargo build --release --all-features
      working-directory: auth-service
      
    - name: Run performance tests
      run: |
        cargo test --test '*' performance \
          --all-features \
          --release \
          --verbose \
          -- --test-threads=1 --nocapture
      working-directory: auth-service
      
    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: auth-service/test-results/performance.log
        retention-days: 30

  # MFA tests job
  mfa-tests:
    name: MFA Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: quick-validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          auth-service/target
        key: ${{ runner.os }}-mfa-cargo-${{ hashFiles('auth-service/Cargo.lock') }}
        
    - name: Run MFA tests
      run: |
        cargo test --test '*' mfa \
          --all-features \
          --verbose \
          -- --test-threads=2 --nocapture
      working-directory: auth-service

  # Code coverage job
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [unit-tests, integration-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview
        
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          auth-service/target
        key: ${{ runner.os }}-coverage-cargo-${{ hashFiles('auth-service/Cargo.lock') }}
        
    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov
      
    - name: Generate code coverage
      run: |
        cargo llvm-cov --all-features \
          --workspace \
          --lcov \
          --output-path lcov.info \
          --ignore-filename-regex "tests/.*"
      working-directory: auth-service
      env:
        RUST_LOG: debug
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: auth-service/lcov.info
        directory: auth-service
        flags: auth-service
        name: auth-service-coverage
        fail_ci_if_error: false
        
    - name: Generate coverage report
      run: |
        cargo llvm-cov --all-features \
          --html \
          --output-dir coverage-html \
          --ignore-filename-regex "tests/.*"
      working-directory: auth-service
      
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: auth-service/coverage-html
        retention-days: 30

  # Benchmarks job (optional)
  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests, integration-tests]
    if: github.event.inputs.run_benchmarks == 'true' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          auth-service/target
        key: ${{ runner.os }}-bench-cargo-${{ hashFiles('auth-service/Cargo.lock') }}
        
    - name: Run benchmarks
      run: |
        cargo bench --features benchmarks \
          -- --output-format html
      working-directory: auth-service
      
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: auth-service/target/criterion
        retention-days: 30

  # Security audit job
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install cargo-audit
      run: cargo install cargo-audit --force
      
    - name: Run security audit
      run: cargo audit
      working-directory: auth-service
      
    - name: Check for known vulnerabilities
      run: cargo audit --deny warnings
      working-directory: auth-service
      continue-on-error: true

  # Dependency check job
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install cargo-deny
      run: cargo install cargo-deny --force
      
    - name: Run dependency check
      run: cargo deny check
      working-directory: auth-service

  # Summary job
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-tests, performance-tests, mfa-tests, coverage]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate test summary
      run: |
        echo "# Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Unit tests
        if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
          echo "✅ Unit Tests: **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Unit Tests: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Integration tests
        if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "✅ Integration Tests: **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Integration Tests: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Security tests
        if [[ "${{ needs.security-tests.result }}" == "success" ]]; then
          echo "✅ Security Tests: **PASSED**" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.security-tests.result }}" == "skipped" ]]; then
          echo "⏭️ Security Tests: **SKIPPED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Security Tests: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Performance tests
        if [[ "${{ needs.performance-tests.result }}" == "success" ]]; then
          echo "✅ Performance Tests: **PASSED**" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.performance-tests.result }}" == "skipped" ]]; then
          echo "⏭️ Performance Tests: **SKIPPED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Performance Tests: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # MFA tests
        if [[ "${{ needs.mfa-tests.result }}" == "success" ]]; then
          echo "✅ MFA Tests: **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ MFA Tests: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Coverage
        if [[ "${{ needs.coverage.result }}" == "success" ]]; then
          echo "✅ Code Coverage: **PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Code Coverage: **FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage Report: Available as workflow artifact" >> $GITHUB_STEP_SUMMARY
        echo "- Performance Results: Available as workflow artifact" >> $GITHUB_STEP_SUMMARY
        echo "- Test Logs: Check individual job outputs" >> $GITHUB_STEP_SUMMARY
        
    - name: Check overall result
      run: |
        if [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
           [[ "${{ needs.integration-tests.result }}" != "success" ]] || \
           [[ "${{ needs.mfa-tests.result }}" != "success" ]]; then
          echo "❌ Critical tests failed"
          exit 1
        fi
        
        echo "✅ All critical tests passed"