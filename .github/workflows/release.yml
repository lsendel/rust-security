name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # RELEASE VALIDATION
  # ============================================================================
  
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: Validate version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Check if prerelease
          if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
            echo "is-prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Release version: $VERSION"

      - name: Check if version exists
        run: |
          if git tag --list | grep -q "^${{ steps.version.outputs.version }}$"; then
            echo "Error: Version ${{ steps.version.outputs.version }} already exists"
            exit 1
          fi

  # ============================================================================
  # BUILD RELEASE ARTIFACTS
  # ============================================================================
  
  build-artifacts:
    name: Build Release Artifacts
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    needs: [validate-release]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive-name: rust-security-linux-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            archive-name: rust-security-linux-aarch64
          - os: macos-latest
            target: x86_64-apple-darwin
            archive-name: rust-security-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            archive-name: rust-security-macos-aarch64
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Install Rust
        uses: dtolnay/rust-toolchain@21dc36fb71dd22e3317045c0c31a3f4249868b17 # stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install gcc-aarch64-linux-gnu

      - name: Build release binary
        run: |
          if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          fi
          
          cargo build --release --target ${{ matrix.target }} --bin auth-service
          cargo build --release --target ${{ matrix.target }} --bin policy-service

      - name: Create archive
        run: |
          mkdir -p dist
          
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp target/${{ matrix.target }}/release/auth-service.exe dist/
            cp target/${{ matrix.target }}/release/policy-service.exe dist/
            cd dist && 7z a ${{ matrix.archive-name }}.zip *
          else
            cp target/${{ matrix.target }}/release/auth-service dist/
            cp target/${{ matrix.target }}/release/policy-service dist/
            tar -czf ${{ matrix.archive-name }}.tar.gz -C dist .
          fi

      - name: Generate checksums
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            sha256sum ${{ matrix.archive-name }}.zip > ${{ matrix.archive-name }}.zip.sha256
          else
            sha256sum ${{ matrix.archive-name }}.tar.gz > ${{ matrix.archive-name }}.tar.gz.sha256
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        with:
          name: release-artifacts-${{ matrix.target }}
          path: |
            ${{ matrix.archive-name }}.*

  # ============================================================================
  # BUILD AND SIGN CONTAINER IMAGES
  # ============================================================================
  
  build-containers:
    name: Build Container Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [validate-release]
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb # v3.3.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20 # v3.1.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81 # v5.5.1
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
          labels: |
            org.opencontainers.image.title=Rust Security Platform
            org.opencontainers.image.description=Production-ready authentication and authorization platform
            org.opencontainers.image.vendor=Rust Security Team

      - name: Build and push container image
        id: build
        uses: docker/build-push-action@2cdde995de11925a030ce8070c3d77a52ffcf1c0 # v5.3.0
        with:
          context: .
          file: ./security/configs/Dockerfile.security
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.validate-release.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@59acb6260d9c0ba8f4a2f9d9b48431a222b68e20 # v3.5.0

      - name: Sign container image
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes \
            --annotations "version=${{ needs.validate-release.outputs.version }}" \
            --annotations "repo=${{ github.repository }}" \
            --annotations "ref=${{ github.sha }}" \
            ${{ steps.meta.outputs.tags }}@${{ steps.build.outputs.digest }}

  # ============================================================================
  # PACKAGE HELM CHARTS
  # ============================================================================
  
  package-helm:
    name: Package Helm Charts
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate-release]
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Set up Helm
        uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814 # v3.5
        with:
          version: v3.13.0

      - name: Update chart versions
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          VERSION_NO_V="${VERSION#v}"
          
          # Only update charts if they exist
          if [ -d "helm/auth-service" ]; then
            yq eval ".version = \"$VERSION_NO_V\"" -i helm/auth-service/Chart.yaml
            yq eval ".appVersion = \"$VERSION_NO_V\"" -i helm/auth-service/Chart.yaml
          fi
          
          if [ -d "helm/policy-service" ]; then
            yq eval ".version = \"$VERSION_NO_V\"" -i helm/policy-service/Chart.yaml
            yq eval ".appVersion = \"$VERSION_NO_V\"" -i helm/policy-service/Chart.yaml
          fi

      - name: Package charts
        run: |
          if [ -d "helm/auth-service" ]; then
            helm package helm/auth-service
          fi
          if [ -d "helm/policy-service" ]; then
            helm package helm/policy-service
          fi

      - name: Sign charts
        run: |
          if ls *.tgz 1> /dev/null 2>&1; then
            helm plugin install https://github.com/sigstore/helm-sigstore
            for chart in *.tgz; do
              helm sigstore sign "$chart"
            done
          else
            echo "No Helm charts found to sign"
          fi

      - name: Upload chart packages
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        if: success()
        with:
          name: helm-charts
          path: |
            *.tgz
            *.tgz.prov
          if-no-files-found: ignore

  # ============================================================================
  # GENERATE RELEASE NOTES
  # ============================================================================
  
  generate-release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate-release]
    outputs:
      release-notes: ${{ steps.notes.outputs.notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          PREV_VERSION=$(git tag --sort=-version:refname | grep -v "$VERSION" | head -n1)
          
          if [[ -z "$PREV_VERSION" ]]; then
            PREV_VERSION=$(git rev-list --max-parents=0 HEAD)
          fi
          
          # Generate changelog
          cat > release-notes.md << EOF
          ## What's Changed
          
          $(git log --pretty=format:"* %s (%h)" ${PREV_VERSION}..HEAD | grep -v "Merge pull request")
          
          ## Security Updates
          
          * All dependencies updated to latest secure versions
          * Container images signed with Cosign
          * SBOM included with release artifacts
          
          ## Breaking Changes
          
          _No breaking changes in this release_
          
          ## Installation
          
          ### Container Images
          \`\`\`
          docker pull ghcr.io/${{ github.repository }}:$VERSION
          \`\`\`
          
          ### Helm Charts
          \`\`\`
          helm repo add rust-security https://github.com/${{ github.repository }}/releases/download/$VERSION
          helm install auth-service rust-security/auth-service --version ${VERSION#v}
          \`\`\`
          
          ### Binary Downloads
          
          * [Linux x86_64](https://github.com/${{ github.repository }}/releases/download/$VERSION/rust-security-linux-x86_64.tar.gz)
          * [Linux ARM64](https://github.com/${{ github.repository }}/releases/download/$VERSION/rust-security-linux-aarch64.tar.gz)
          * [macOS x86_64](https://github.com/${{ github.repository }}/releases/download/$VERSION/rust-security-macos-x86_64.tar.gz)
          * [macOS ARM64](https://github.com/${{ github.repository }}/releases/download/$VERSION/rust-security-macos-aarch64.tar.gz)
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_VERSION}...${VERSION}
          EOF
          
          # Use proper output format for multiline strings
          {
            echo 'notes<<EOF'
            cat release-notes.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Upload release notes
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        with:
          name: release-notes
          path: release-notes.md

  # ============================================================================
  # CREATE GITHUB RELEASE
  # ============================================================================
  
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate-release, build-artifacts, build-containers, package-helm, generate-release-notes]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3

      - name: Create GitHub Release
        uses: ncipollo/release-action@2c591bcc8ecdcd2db72b97d6147f871fcd833ba5 # v1.14.0
        with:
          tag: ${{ needs.validate-release.outputs.version }}
          name: Release ${{ needs.validate-release.outputs.version }}
          body: ${{ needs.generate-release-notes.outputs.release-notes }}
          draft: false
          prerelease: ${{ needs.validate-release.outputs.is-prerelease }}
          artifacts: "release-artifacts-*/*,helm-charts/*"
          token: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # NOTIFY RELEASE
  # ============================================================================
  
  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate-release, create-release]
    if: always()
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@28ba43ae48961b90635b50953d216767a6bea486 # v3.16.2
        with:
          status: ${{ job.status }}
          text: |
            ðŸš€ **Release ${{ needs.validate-release.outputs.version }}** is now available!
            
            ðŸ“¦ **Artifacts:**
            â€¢ Container images signed with Cosign
            â€¢ Multi-platform binaries (Linux, macOS)
            â€¢ Helm charts for Kubernetes deployment
            â€¢ Complete SBOM for supply chain security
            
            ðŸ”— **Links:**
            â€¢ [Release Notes](https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate-release.outputs.version }})
            â€¢ [Container Registry](https://ghcr.io/${{ github.repository }})
            â€¢ [Documentation](https://github.com/${{ github.repository }}/tree/${{ needs.validate-release.outputs.version }}/docs)
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        continue-on-error: true

      - name: Update documentation
        run: |
          # Trigger documentation update workflow
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"release","client_payload":{"version":"${{ needs.validate-release.outputs.version }}"}}'
        continue-on-error: true
