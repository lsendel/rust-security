# Alertmanager Configuration Guide

This directory contains the Alertmanager configuration for the Rust Security Workspace monitoring system. Alertmanager handles routing and delivery of alerts generated by Prometheus to various notification channels.

## Configuration Files

- `alertmanager.yml` - Main Alertmanager configuration file
- `templates/security.tmpl` - Custom templates for security alerts
- `README.md` - This configuration guide

## Notification Channels

The alerting system is configured with multiple notification channels based on alert severity and category:

### 1. Critical Security Alerts
**Channels:** PagerDuty + Slack + Email + Webhook (SIEM)
- **Response Time:** Immediate (0s group wait)
- **Repeat Interval:** 30 minutes
- **Recipients:** Security team, on-call engineer

### 2. Critical Availability Alerts  
**Channels:** PagerDuty + Slack
- **Response Time:** Immediate (0s group wait)
- **Repeat Interval:** 30 minutes
- **Recipients:** Operations team, on-call engineer

### 3. Compliance Violations
**Channels:** Email + Webhook (Compliance System)
- **Response Time:** Immediate (0s group wait) 
- **Repeat Interval:** 1 hour
- **Recipients:** Compliance team, Security team, Legal team

### 4. High Priority Security Alerts
**Channels:** Slack + Email
- **Response Time:** 30 seconds
- **Repeat Interval:** 2 hours
- **Recipients:** Security team

### 5. High Priority Operational Alerts
**Channels:** Slack
- **Response Time:** 1 minute
- **Repeat Interval:** 4 hours
- **Recipients:** Operations team

### 6. SLA Breach Notifications
**Channels:** Email + Slack
- **Response Time:** 2 minutes
- **Repeat Interval:** 6 hours
- **Recipients:** SLA team, Management

### 7. Medium Priority Alerts (Business Hours Only)
**Channels:** Slack + Email
- **Response Time:** 5 minutes
- **Repeat Interval:** 8 hours
- **Schedule:** Monday-Friday, 9:00 AM - 5:00 PM EST

## Setup Instructions

### Prerequisites

1. **Alertmanager Installed**
   ```bash
   # Download and install Alertmanager
   wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz
   tar xzf alertmanager-0.26.0.linux-amd64.tar.gz
   sudo mv alertmanager-0.26.0.linux-amd64/alertmanager /usr/local/bin/
   ```

2. **Configuration Directory**
   ```bash
   sudo mkdir -p /etc/alertmanager/templates
   sudo cp alertmanager.yml /etc/alertmanager/
   sudo cp templates/security.tmpl /etc/alertmanager/templates/
   ```

### 1. Configure Slack Integration

1. **Create Slack Webhooks:**
   - Go to your Slack workspace settings
   - Navigate to Apps â†’ Incoming Webhooks
   - Create webhooks for each channel:
     - `#security-alerts` (for security notifications)
     - `#ops-alerts` (for operational notifications)
     - `#general-alerts` (for medium priority alerts)
     - `#sla-monitoring` (for SLA notifications)

2. **Update Configuration:**
   ```bash
   # Replace webhook URLs in alertmanager.yml
   sed -i 's/SLACK_WEBHOOK_URL_SECURITY/your-security-webhook-url/g' /etc/alertmanager/alertmanager.yml
   sed -i 's/SLACK_WEBHOOK_URL_OPS/your-ops-webhook-url/g' /etc/alertmanager/alertmanager.yml
   sed -i 's/SLACK_WEBHOOK_URL_SLA/your-sla-webhook-url/g' /etc/alertmanager/alertmanager.yml
   ```

### 2. Configure PagerDuty Integration

1. **Create PagerDuty Services:**
   - Log into PagerDuty console
   - Create services for:
     - Security Critical Alerts
     - Operations Critical Alerts
   - Generate integration keys for each service

2. **Update Configuration:**
   ```bash
   # Replace routing keys in alertmanager.yml
   sed -i 's/SECURITY_CRITICAL_ROUTING_KEY/your-security-routing-key/g' /etc/alertmanager/alertmanager.yml
   sed -i 's/OPS_CRITICAL_ROUTING_KEY/your-ops-routing-key/g' /etc/alertmanager/alertmanager.yml
   ```

### 3. Configure Email Notifications

1. **SMTP Configuration:**
   Update the global SMTP settings in `alertmanager.yml`:
   ```yaml
   global:
     smtp_smarthost: 'your-smtp-server:587'
     smtp_from: 'security-alerts@yourcompany.com'
     smtp_auth_username: 'your-smtp-username'
     smtp_auth_password: 'your-smtp-password'
     smtp_require_tls: true
   ```

2. **Update Email Addresses:**
   Replace placeholder email addresses with your team's actual addresses:
   ```bash
   sed -i 's/security-team@company.com/your-security-team@yourcompany.com/g' /etc/alertmanager/alertmanager.yml
   sed -i 's/compliance@company.com/your-compliance-team@yourcompany.com/g' /etc/alertmanager/alertmanager.yml
   sed -i 's/management@company.com/your-management-team@yourcompany.com/g' /etc/alertmanager/alertmanager.yml
   ```

### 4. Configure Webhook Integrations

1. **SIEM Integration:**
   ```bash
   # Update SIEM webhook URL and token
   sed -i 's|https://siem.company.com/api/security-alerts|your-siem-webhook-url|g' /etc/alertmanager/alertmanager.yml
   sed -i 's/SIEM_API_TOKEN/your-siem-api-token/g' /etc/alertmanager/alertmanager.yml
   ```

2. **Compliance System Integration:**
   ```bash
   # Update compliance system webhook URL and token
   sed -i 's|https://compliance-system.company.com/api/alerts|your-compliance-webhook-url|g' /etc/alertmanager/alertmanager.yml
   sed -i 's/COMPLIANCE_API_TOKEN/your-compliance-api-token/g' /etc/alertmanager/alertmanager.yml
   ```

### 5. Configure Prometheus Integration

Update your Prometheus configuration to send alerts to Alertmanager:

```yaml
# prometheus.yml
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

rule_files:
  - "security-alerts.yml"
```

## Starting Alertmanager

### Systemd Service

1. **Create Service File:**
   ```bash
   sudo tee /etc/systemd/system/alertmanager.service > /dev/null <<EOF
   [Unit]
   Description=Alertmanager
   Wants=network-online.target
   After=network-online.target

   [Service]
   User=alertmanager
   Group=alertmanager
   Type=simple
   ExecStart=/usr/local/bin/alertmanager \\
     --config.file=/etc/alertmanager/alertmanager.yml \\
     --storage.path=/var/lib/alertmanager/ \\
     --web.console.libraries=/etc/alertmanager/console_libraries \\
     --web.console.templates=/etc/alertmanager/consoles \\
     --web.external-url=

   [Install]
   WantedBy=multi-user.target
   EOF
   ```

2. **Create User and Directories:**
   ```bash
   sudo useradd --no-create-home --shell /bin/false alertmanager
   sudo mkdir -p /var/lib/alertmanager
   sudo chown alertmanager:alertmanager /var/lib/alertmanager
   sudo chown -R alertmanager:alertmanager /etc/alertmanager
   ```

3. **Start Service:**
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable alertmanager
   sudo systemctl start alertmanager
   ```

### Docker Deployment

```bash
docker run -d \\
  --name alertmanager \\
  -p 9093:9093 \\
  -v /etc/alertmanager:/etc/alertmanager \\
  prom/alertmanager:latest \\
  --config.file=/etc/alertmanager/alertmanager.yml \\
  --storage.path=/alertmanager
```

## Testing Alerts

### 1. Test Configuration Syntax
```bash
# Validate configuration
amtool config routes test --config.file=alertmanager.yml

# Check configuration
amtool config show --config.file=alertmanager.yml
```

### 2. Send Test Alert
```bash
# Send a test alert to verify notification channels
curl -H "Content-Type: application/json" -d '[{
  "labels": {
    "alertname": "TestAlert",
    "severity": "critical",
    "category": "security",
    "service": "test-service"
  },
  "annotations": {
    "summary": "Test alert for notification validation",
    "description": "This is a test alert to verify notification channels are working",
    "runbook_url": "https://docs.company.com/runbooks/test"
  }
}]' http://localhost:9093/api/v1/alerts
```

### 3. Verify Alert Routing
```bash
# Check alert routing for different labels
amtool config routes test --config.file=alertmanager.yml \\
  severity=critical category=security service=auth-service
```

## Monitoring and Maintenance

### 1. Monitor Alertmanager Health
```bash
# Check Alertmanager status
curl http://localhost:9093/-/healthy

# View current alerts
curl http://localhost:9093/api/v1/alerts
```

### 2. Silence Management
```bash
# Create a silence
amtool silence add alertname=TestAlert --duration=1h --comment="Maintenance window"

# List active silences
amtool silence query

# Expire a silence
amtool silence expire <silence-id>
```

### 3. Configuration Reload
```bash
# Reload configuration without restart
curl -X POST http://localhost:9093/-/reload
```

## Security Considerations

1. **Access Control:** Ensure Alertmanager is only accessible from authorized networks
2. **Webhook Security:** Use HTTPS and authentication tokens for webhook endpoints
3. **Credential Management:** Store sensitive credentials (API tokens, passwords) securely
4. **Network Security:** Configure firewall rules to restrict access to port 9093
5. **Log Monitoring:** Monitor Alertmanager logs for suspicious activity

## Troubleshooting

### Common Issues

1. **Alerts Not Firing:**
   - Check Prometheus rule evaluation: `curl http://prometheus:9090/api/v1/rules`
   - Verify alerting configuration in Prometheus
   - Check Alertmanager connectivity from Prometheus

2. **Notifications Not Received:**
   - Verify webhook URLs and API tokens
   - Check Alertmanager logs: `journalctl -u alertmanager -f`
   - Test notification channels manually

3. **Configuration Errors:**
   - Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('alertmanager.yml'))"`
   - Check routing logic: `amtool config routes test`

### Log Analysis
```bash
# View Alertmanager logs
journalctl -u alertmanager -f

# Check for configuration issues
journalctl -u alertmanager --no-pager | grep -i error

# Monitor notification attempts
journalctl -u alertmanager --no-pager | grep -i "notify"
```

## Support

For issues with this configuration:
- **Security Team:** security-team@company.com
- **Operations Team:** ops-team@company.com
- **Documentation:** https://prometheus.io/docs/alerting/latest/alertmanager/

---

**Last Updated:** 2025-08-16  
**Configuration Version:** 1.0  
**Maintainer:** Security Engineering Team